name: Scheduled Crawl

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

env:
  PROJECT_ID: yt-transcript-demo-2025
  SERVICE_NAME: mcphub-api
  REGION: asia-northeast1

jobs:
  crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Run crawl via Cloud Run Admin API
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format='value(status.url)')
          curl -s -X POST "$SERVICE_URL/admin/crawl" \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"max_servers": 500}'
          echo "Crawl triggered: $SERVICE_URL"
